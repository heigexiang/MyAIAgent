[
  {
    "timestamp": "2025-11-27T12:58:56Z",
    "user": "为什么gpt-5 api同时启用联网搜索和流式响应可能会出现问题？",
    "assistant": "简要结论：同时启用“联网搜索（web search）”和“流式响应（SSE streaming）”，最常见的问题是交互生命周期冲突、事件解析复杂度上升、引用/合规处理不完整、用户体验卡顿，以及成本与速率限制更难控制。下面分点说明，并给出规避建议。\n\n为什么会出问题\n- 生命周期冲突（先说后查）：流式响应会边生成边输出，而联网搜索属于工具调用，会在流中插入一次或多次阻塞的外部检索步骤。若你一开始就把文本 delta 推给用户，模型可能“先说后查”，随后再用搜索结果修正，造成前后不一致甚至自我否定。官方流式文档明确：流里会发出多类事件（如 response.output_text.delta、function call 相关事件），需要等待特定事件完成再继续。建议在收到工具调用结果前暂缓正文输出或分两阶段输出。参见 OpenAI “Streaming API responses”指南的事件类型与注意事项。 \n- 事件流解析复杂：开启 web search 后，SSE 流不只包含文本增量，还包含工具相关的事件项（例如工具调用开始/完成、函数参数增量等）。如果客户端简单地按行渲染，会把工具事件或未完参数误当成正文。需要准确区分并缓冲这些事件，至少等待“函数参数完成/工具调用完成”类事件再更新 UI。官方“使用工具/函数调用”的指南说明了工具调用的多步往返与需等待的时机。 \n- 引用与溯源不完整：web search 的响应通常带有 citations/annotations；若你在检索尚未完成就流式输出正文，用户会看到没有引用的片段，或引用列表在结尾才出现，影响可信度。官方“Web search”文档指出模型会产出 web_search_call 以及含注释的 message 项，默认内联引用需要等检索完成才能完整呈现。 \n- 用户体验卡顿与节奏错位：普通检索尚可，深度/代理式搜索（agentic、deep research）可能持续几秒到数分钟；这会让流式文本突然停滞或反复改写，用户以为“卡住”。应当利用事件来显示“正在搜索/打开页面”等阶段性状态，而不是只渲染文本。官方页面区分了非推理检索、代理式检索与深度研究模式的时延与开销差异。 \n- 成本与速率限制更难控：每次 search/open_page 都是一次工具调用并计费；同时，流式连接占用通道与令牌配额，若你频繁中断/重试，可能在还没得到最终答案前就产生较高成本并触发速率限制。API 参考说明了需要关注限速头与请求 ID，用于排查与配额管理；Web search 文档也提示搜索动作会产生工具调用成本。 \n- 合规与隐私风险：在流式场景下，未审核的部分文本会直接面向终端用户；官方也提醒流式使内容审核更困难。若在某些托管环境（如 Azure 的 Web search 预览）启用外部检索，还涉及跨区域数据流动与额外条款，需要在企业合规上提前评估。 \n\n实用规避建议\n- 两阶段输出（推荐）：第一阶段只显示“检索进度”与状态事件，待工具调用完成后再开启正文的文本 delta 流；或直接先关闭流式，待检索完成后再以流式方式生成和推送总结段。\n- 明确工具调用策略：对需要强制溯源的回答，将 tool_choice 设为 required 或在系统指令中要求“完成搜索并拿到 citations 后再输出正文”；否则允许 auto 但在 UI 上标注“可能基于模型内知识，正在尝试补充检索”。\n- 事件级渲染与缓冲：只把 response.output_text.delta 渲染到界面；对 function/web_search 的事件与 annotations 进行缓冲，等到 response.completed 或工具调用完成后再一次性插入引用与来源。\n- 超时与降级：为检索设定超时阈值（例如 5–10 秒）；超过阈值先给出“基于已知资料的暂定回答”，并在检索完成后以“附加更新”方式补充与矫正。\n- 成本/速率治理：限制 max_tool_calls、降低搜索深度；对重复问题启用缓存（把最近查询的来源与摘要复用）；监控并使用 x-ratelimit-* 头与 x-request-id 做调度与重试。 \n- 合规与审核：对高风险领域（医疗、法律、报价），禁用流式或对流式结果做服务器端审核后再下发；在 Azure 场景下审阅 Web search 预览的合规条款与数据流动说明。 \n\n注：截至 2025-11-27，OpenAI 官方文档同时提供了“Streaming API responses”与“Web search/Using tools”等页面，说明了事件模型、工具调用与引用产出方式；以上问题与建议均与这些官方行为模型相吻合。 [Web search - OpenAI API](https:...(截断)"
  }
]