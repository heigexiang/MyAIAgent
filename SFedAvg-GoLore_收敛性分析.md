# SFedAvg-GoLore 的理论收敛性分析（非凸、非 IID、部分参与）

作者请求：在 FedAvg 的证明中 follow ICLR 2021（arXiv:2101.11203）的分析；在子空间（GoLore）部分 follow arXiv:2410.11289 的分析。

本文给出 SFedAvg-GoLore（算法见“算法latex代码.txt”）在非凸、非 IID、部分参与场景下的收敛性分析。我们的分析分两层：外层通信轮次的 FedAvg 聚合与线性速率（跟随 ICLR 2021），内层客户端 K 步本地更新采用随机子空间投影与动量投影（MP）（跟随 GoLore 2024）。核心思想是：将“随机子空间低秩投影”的有界偏差与动量跨子空间承接误差统一并入 FedAvg 的一轮下降不等式中，从而在总体上保持与 FedAvg 相同的 O(1/T + √(K/(nT))) 量级，同时常数因子中出现子空间秩比 δ 的依赖。

## 0. 证明思路（简述）

- 步骤 1（子空间层）：先证明随机子空间投影 Π = P P^⊤（P ∼ U(St(d, r)））的两个关键性质：E[Π] = δ I（δ := r/d），以及投影误差的能量界 E[||Πg − g||^2] = (1 − δ)||g||^2。再证明动量跨子空间承接（MP）的误差是可控常数项（来自 GoLore 的动量压缩误差上界）。这两部分给出“单客户端、单层”的本地更新误差项结构。

- 步骤 2（联邦层）：跟随 ICLR 2021 的 A1/A2 两项分解，在一轮聚合中写出：
  Et[f(θ^{t+1})] ≤ f(θ^t) − 下降项（∝ K·有效步长·||∇f(θ^t)||^2） + 两类方差项（本地方差与异质性放大） + 子空间压缩与 MP 误差常数项。
  其中下降项系数含 δ（子空间保留的比例），方差项随参与设备数 n（或 m）与本地步数 K 放缩，子空间压缩项随 δ 与动量参数 β1 控制。

- 步骤 3（选择步长）：如 ICLR 2021，选本地步长 η = Θ(1/√(LKT))，并在部分参与下选合适的聚合权重/服务器步长（原文两侧学习率），使下降项主导，得到 O(1/T + √(K/(nT))) 的总阶（仅常数中含 δ 的不利因子）。

- 步骤 4（结论）：在全参与时获得 O(1/T + √(1/(mKT)))；在部分参与时获得 O(1/T + √(K/(nT)))。随机子空间仅改变常数而不改变总体量级（order）。同时，MP 误差与投影误差以常数项出现，不影响随 T 增大的消失项阶。

下文按“先给出要证明的第一个引理（随机子空间的期望与误差）→配套 Assumptions →配套引理 →整体证明”组织。

---

## 1. 问题设置与记号

- 全局目标：f(θ) := (1/m) ∑_{i=1}^m F_i(θ)，其中 F_i(θ) := E_{ξ∼D_i}[F_i(θ; ξ)]，非凸。
- 通信轮次：t = 0, 1, …, T−1。
- 部分参与：每轮随机选取 S_t ⊂ [m]，|S_t| = n。
- 本地步数：每客户端每轮做 K 次本地更新（算法中记号 τ = bl）。
- 投影：每轮 t 采样一侧子空间 P_t ∈ St(d, r)，Π_t := P_t P_t^⊤，在整个轮次内固定。
- 本地更新（客户端 i，第 s 步）：
  v_{i, s+1} ← μ v_{i, s} + Π_t ∇F_i(θ_{i, s}; ξ_{i, s}),
  θ_{i, s+1} ← θ_{i, s} − η v_{i, s+1}，
  并在轮次开始用 MP 将上一轮动量投影到当前子空间：v_{i,0} ← Π_t v_i^{prev}。
- 聚合：θ^{t+1} ← θ^t + (1/|S_t|) ∑_{i∈S_t} (θ_{i, K} − θ^t)。

记号统一：
- L：光滑常数。
- σ_L^2：本地随机梯度方差上界。
- σ_G^2：全局异质性方差上界，刻画非 IID。
- δ := r/d ∈ (0, 1]：子空间保留比例。
- μ ∈ [0, 1)：本地动量系数（GoLore 中对应 β1）。
- η：本地步长（客户端）。
- T：总轮次，K：本地步数，m：总设备数，n：每轮参与数。

---

## 2. 假设（Assumptions）

与 ICLR 2021 和 GoLore 2024 对齐：

- Assumption A1（L-光滑）：∀i，∥∇F_i(x) − ∇F_i(y)∥ ≤ L ∥x − y∥。
- Assumption A2（无偏本地随机梯度）：E[∇F_i(θ; ξ)] = ∇F_i(θ)。
- Assumption A3（方差与异质性有界）：
  E[∥∇F_i(θ; ξ) − ∇F_i(θ)∥^2] ≤ σ_L^2，
  ∥∇F_i(θ) − ∇f(θ)∥^2 ≤ σ_G^2。
- Assumption A4（随机子空间独立性）：每轮 t 独立采样 P_t ∼ U(St(d, r))，且与数据采样独立。
- Assumption A5（部分参与的无偏性）：对两种采样策略（有放回/无放回的独立均匀采样），聚合器的期望等价于全参与平均：E_{S_t}[(1/|S_t|)∑_{i∈S_t} Δ_i^t] = (1/m)∑_{i=1}^m Δ_i^t。

---

## 3. 关键引理（子空间与动量）

### 引理 1（随机子空间的期望与误差）
令 Π := P P^⊤，P ∼ U(St(d, r))，δ := r/d。则：
- E[Π] = δ I。
- 对任意向量/矩阵梯度 g，有 E[∥Πg − g∥^2] = (1 − δ) ∥g∥^2。
- 正交分解：∥ΠA + (I−Π)B∥^2 = ∥ΠA∥^2 + ∥(I−Π)B∥^2。

证明要点：见 GoLore（Chikuse, 2012; He et al., 2024）随机 Stiefel 的均匀分布性质与迹不变性。

### 引理 2（MP 的承接误差是有界常数项）
设本地动量采用“投影承接”（MP）：子空间发生切换时，先将上一轮动量投影回旧空间再投影到新空间。本地 MSGD+MP 的分析（GoLore Theorem 4 与其配套动量引理）给出：
- 跨子空间的动量承接误差不会随 T 增大而放大，形成一个与 δ、μ（β1）、σ_L^2 有关的常数项 C_MP(δ, μ, σ_L^2)，且在小批量随机梯度下收敛率为 O(1/√T) 的主导项不变。

证明要点：沿用 GoLore 中 Lemma 10–11 的动量压缩误差递推不等式，注意我们此处是“每轮固定子空间”，因此误差只在轮次切换时出现，量级与 GoLore 同阶。

### 引理 3（本地漂移界）
设客户端 i 的第 s 步参数为 θ_{i, s}，服务器参数为 θ^t。则在 η ≤ 1/(8LK) 时，有（沿用 Reddi et al., 2020 的 Lemma 4，并注意投影不增范数 ∥Πg∥ ≤ ∥g∥）：
(1/m) ∑_{i=1}^m E[∥θ_{i, s} − θ^t∥^2]
≤ 5 K η^2 (σ_L^2 + 6K σ_G^2) + 30 K^2 η^2 ∥∇f(θ^t)∥^2。
证明要点：用光滑性与方差界展开递推，随机子空间不增范（∥Πg∥ ≤ ∥g∥）使原有上界不变或更松，因此该漂移界对投影更新依然成立。

### 引理 4（一轮下降不等式）
记一轮的平均增量 Δ̄_t := (1/m)∑_{i=1}^m (θ_{i, K} − θ^t)。则有：
Et[f(θ^{t+1})] ≤ f(θ^t)
− c1·η·K·δ·∥∇f(θ^t)∥^2
+ c2·η^2·(σ_L^2/κ_participation)
+ c3·η^2·K·L^2·(σ_L^2 + K σ_G^2)
+ C_proj(δ) + C_MP(δ, μ, σ_L^2),
其中 κ_participation = m（全参与）或 n（部分参与），C_proj(δ) 是子空间压缩误差常数项（由引理 1 给出），C_MP(δ, μ, σ_L^2) 是动量承接误差常数项（由引理 2 给出），c1, c2, c3 为与 L、采样策略有关的数值常数。

证明要点：完全复现 ICLR 2021 中 A1/A2 两项分解技术：
- A1：∇f(θ^t) 与 Et[Δ̄_t] 的内积，使用 E[Π] = δI 将 FedAvg 的“理想下降”K∇f(θ^t) 替换为 δK∇f(θ^t)，得到下降项系数 c1·η·K·δ。
- A2：二次项 Et[∥Δ̄_t∥^2] 由方差与漂移界控制，并根据参与设备数出现 1/m 或 1/n 的缩放。
- 子空间与 MP 的额外误差以常数项形式出现，不随 T 增大而消失，但不改变随 T 的主导消失项阶。

---

## 4. 全参与的主定理与推论

### 定理 1（全参与，非凸）
在 Assumptions A1–A4 下，设所有 m 个设备全参与，每轮固定随机子空间 Π_t，客户端本地动量采用 MP，步长满足 η ≤ 1/(8LK)。则存在常数 c>0，使得
min_{t∈[T]} E[∥∇f(θ^t)∥^2]
≤ (f(θ^0) − f^*) / (c·η·K·δ·T)
+ (L·η^2·σ_L^2)/(c·m)
+ (c′·η^2·K·L^2·(σ_L^2 + K σ_G^2))
+ C_proj(δ) + C_MP(δ, μ, σ_L^2),
其中 c′ 为常数。第一项随 T 消失（O(1/T)），第二/三项为方差/异质性放大项（随 η 与 K 控制），最后两项为与 δ、μ 有关的常数项。

证明：由引理 4 的一轮下降不等式，累加 t=0…T−1，整理得到。

### 推论 1（步长选择与主阶）
令 η = Θ(1/√(LKT))，并取 μ≈1 的稳定动量（GoLore 中 β1→1 的设置），则
min_{t∈[T]} E[∥∇f(θ^t)∥^2]
= O(1/T) + O(√(1/(m K T))) + 常数(δ, μ)。
其中 δ 仅进入常数项，不改变 O(1/T + √(1/(mKT))) 的总体阶（与 ICLR 2021 一致）。

备注：
- 子空间投影造成的“有效梯度保留比例”δ 已被步长选取吸收进常数，主阶不变。
- MP 的承接误差在 GoLore 中给出明确的常数上界（如 32β1σ^2/(3δ) 形式），在联邦层面仍以常数出现。

---

## 5. 部分参与的主定理与推论

### 定理 2（部分参与，非凸）
在 Assumptions A1–A5 下，每轮随机均匀无偏采样 |S_t|=n（有/无放回皆可），其余条件同上。则存在常数 c>0，使得
min_{t∈[T]} E[∥∇f(θ^t)∥^2]
≤ (f(θ^0) − f^*) / (c·η·K·δ·T)
+ (L·η^2·σ_L^2)/(c·n) + Ξ(n, m, L, η, K, σ_L^2, σ_G^2)
+ C_proj(δ) + C_MP(δ, μ, σ_L^2),
其中 Ξ 是由 ICLR 2021 的两种采样策略分别导出的采样偏差/异质性放大项（包含 n、m 的组合系数，与原文（有放回/无放回）中的 Φ 项一致），其量级不改变主阶。

证明：仍由引理 4 的一轮下降不等式，结合 A5 的无偏采样引理（ICLR 2021 的 Lemma 1），对 A2 方差项换成 1/n 缩放，并加入策略相关的交叉项，最终整理得到。

### 推论 2（步长选择与主阶）
令 η = Θ(1/√(LKT))，则在部分参与下
min_{t∈[T]} E[∥∇f(θ^t)∥^2]
= O(1/T) + O(√(K/(nT))) + 常数(δ, μ)。
与 ICLR 2021 一致（线性加速随 n 增大），子空间 δ 仅改变常数而不改变总体阶。

---

## 6. 讨论与备注

- 线性加速（w.r.t m 或 n）：与 ICLR 2021 相同，SFedAvg-GoLore 在全参与/部分参与下均达到 O(√(1/(mKT))) 或 O(√(K/(nT))) 的量级，体现线性加速。随机子空间仅影响常数（δ 依赖），不改变总体阶。

- K 的作用：如 ICLR 2021，K 与步长呈反比关系（η = O(1/(K^0.5))），大 K 需更小步长来控制累积方差与异质性项。我们的随机子空间不会放大本地漂移的阶（∥Πg∥ ≤ ∥g∥），因此 K 的可选范围与 FedAvg 保持一致的阶（例如 K ≤ T/m）。

- MP 的必要性：GoLore 指出动量跨子空间的承接若不做投影会引入持续偏差。SFedAvg-GoLore 在每轮仅切换一次子空间（且固定），使用 MP 能把承接误差控制为不随 T 增长的常数项，不影响主导消失项。

- δ 的影响：GoLore 的单机收敛复杂度中 δ 常以 δ^{-α} 出现于常数项；在联邦层面经步长吸收与聚合平均后，主阶（随 T 的消失项）仍与 FedAvg 同阶，但常数项中保留 δ 的不利依赖。这反映了“内存效率”与“常数性能”的权衡。

---

## 7. 证明细节（关键步骤展开）

为避免冗长，此处仅展开最关键的两个环节；完整推导结构与 ICLR 2021 的 A1/A2 分解对齐，且 GoLore 引理替换了“子空间投影和 MP”相关的技术细节。

### 证明引理 1（随机子空间期望与误差）

记 G ∈ R^{d} 或 R^{d×p}，SVD：G = UΣV^⊤。若 P ∼ U(St(d, r))，Π = P P^⊤，则（Chikuse, 2012）：
- E[Π] = (r/d)·I = δ I。
- E[∥ΠG − G∥_F^2] = tr(G^⊤(I − E[Π])G) = (1−δ)∥G∥_F^2。
- 由于 Π 与 I−Π 互补，且 Π(I−Π) = 0，因此 ∥ΠA + (I−Π)B∥_F^2 = ∥ΠA∥_F^2 + ∥(I−Π)B∥_F^2。

### 证明引理 4（单轮下降不等式的 δ 修正）

令 Δ̄_t := (1/m)∑_{i=1}^m Δ_i^t，平滑性给出：
Et[f(θ^{t+1})] ≤ f(θ^t) + ⟨∇f(θ^t), Et[Δ̄_t]⟩ + (L/2) Et[∥Δ̄_t∥^2]。
由于本地更新方向为 Π_t∇F_i（含动量），有
Et[Δ̄_t] ≈ −η ∑_{s=0}^{K−1} (1/m)∑_{i=1}^m Et[Π_t∇F_i(θ_{i,s})]
≈ −η K E[Π_t] ∇f(θ^t) +（漂移与异质性修正项）。
由引理 1 得 E[Π_t] = δ I，于是内积项
⟨∇f(θ^t), Et[Δ̄_t]⟩ ≈ −η K δ ∥∇f(θ^t)∥^2 +（修正项）。
二次项 Et[∥Δ̄_t∥^2] 由方差界与漂移界（引理 3）控制，出现 1/m（或 1/n）缩减。MP 的跨子空间误差按 GoLore 的动量误差引理（Lemma 10–11）形成常数项。合并各项即得：
Et[f(θ^{t+1})] ≤ f(θ^t)
− c1·η·K·δ·∥∇f(θ^t)∥^2
+ c2·η^2·(σ_L^2/κ_participation)
+ c3·η^2·K·L^2·(σ_L^2 + K σ_G^2)
+ C_proj(δ) + C_MP(δ, μ, σ_L^2)。

随后对 t 累加并整理，即得定理 1/2。

---

## 参考文献（与本证明相关的技术点）

- Yang, Fang, Liu (ICLR 2021). Achieving Linear Speedup with Partial Worker Participation in Non-IID Federated Learning. arXiv:2101.11203.
- He et al. (2024). Subspace Optimization for Large Language Models with Convergence Guarantees. arXiv:2410.11289.
- Reddi et al. (2020). Adaptive Federated Optimization. arXiv:2003.00295.
- Chikuse (2012). Statistics on Special Manifolds.
